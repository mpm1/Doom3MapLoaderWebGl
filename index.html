<html>
    <head>
        <title>Doom 3: WebGL 2 Test</title>

        <link rel="stylesheet" href="custom.css"/>

        <script src="./lib/jquery-3.4.1.min.js"></script>
        <!-- jszip can be found here: https://stuk.github.io/jszip/ -->
        <script src="./lib/jszip.min.js"></script>
        <!-- tgajs can be found here: https://github.com/schmittl/tgajs -->
        <script src="./lib/tga.js"></script>

        <!-- Engine Files -->
        <script src="./src/controls.js"></script>
        <script src="./src/file.js"></script>
        <script src="./src/math.js"></script>
        <script src="./src/map.js"></script>
        <script src="./src/display.js"></script>
        <script src="./src/console.js"></script>
        <script src="./src/doom3.js"></script>
    </head>
    <body>
        <div id="gameContainer">
            <canvas id="gameCanvas" width="1280" height="720">
            </canvas>

            <div id="gameConsole">
                <div class="output"></div>
                <input type="text" class="input"></input>
                <button class="inputClick">Execute</button>
            </div>
        </div>

        <script type="text/javascript">
            var forwardSpeed = 2.5;
            var strifeSpeed = 3.0;
            var game = new Game("#gameCanvas", "#gameConsole > .output", "#gameConsole > .input", "#gameConsole > .inputClick");
            var controls = new Controls($("#gameCanvas")[0]);
            controls.controls.Mouse.multiplier = 0.01;

            game.console.writeLine("Welcome to the Doom 3 map loader and viewer.");
            

            function handleControls(time) {
                var map = game.map;

                if(map && map.isLoaded){
                    controls.update(time);

                    // Movement
                    var h = controls.controls.Horizontal.value;
                    var v = controls.controls.Vertical.value;

                    var x, y, z;
                    var backward = map.camera.transform.backward;
                    var right = map.camera.transform.right;

                    x = (-backward[0] * forwardSpeed * h) + (right[0] * strifeSpeed * v);
                    y = (-backward[1] * forwardSpeed * h) + (right[1] * strifeSpeed * v);
                    z = (-backward[2] * forwardSpeed * h) + (right[2] * strifeSpeed * v);
                    
                    // Horizontal movement and strifing movement are independent of each other.
                    map.camera.transform.translate(x, y, z);

                    // Look controls
                    var mouse = controls.controls.Mouse;
                    if(mouse.magnitude > 0.0){
                        map.camera.transform.rotate(mouse.magnitude, mouse.normal[1], mouse.normal[0], 0.0);
                    }
                }
            }

            function gameloop(time){
                window.requestAnimationFrame(gameloop);

                var secondsDelta = time / 1000.0;

                handleControls(time);
                game.loop(secondsDelta);
            }

            gameloop(0);
        </script>

    </body>
</html>